<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>You‚Äôre Invited to My 7th Birthday!</title>
  <meta name="theme-color" content="#BBA5E3" />
  <style>
    :root{
      --ink:#333; --muted:#666; --card:#fff;
      --lilac:#BBA5E3; --blush:#F7A8B8; --baby:#A8D8F0; --lav:#9C8ADE;
      --toast:#E8DFF5; --shadow:0 14px 34px rgba(23,16,54,.10); --radius:22px;
      --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --border:#e5e7eb;
      --bar-start:#8b7be0; --bar-end:#b8a7ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at -10% -10%, #ffeaf3 0, #fff 60%),
        radial-gradient(900px 520px at 110% 0%, #e9f8ff 0, #fff 55%),
        linear-gradient(180deg,#fff, #f7f9ff);
      min-height:100vh;
    }
    .container{max-width:1000px;margin:0 auto;padding:18px 16px 140px; position:relative; z-index:1}
    .hero{ background: linear-gradient(135deg, #ede7ff 0%, #d3fff3 100%); border-radius:28px; padding:26px 18px 20px; text-align:center; box-shadow:var(--shadow); }
    .hero h1{margin:4px 0 1rem; font-size:clamp(1.6rem, 3.5vw, 2.3rem); line-height:1.18;}
    #hiName{font-weight:800;opacity:.95;margin:0 0 10px; font-size:1.4rem}
    .tagline{margin:0 auto 10px; max-width:44ch; font-size:1.06rem}
    .hero-photo-wrap{background:rgba(255,255,255,.85); border:1px solid rgba(255,255,255,.6);
      border-radius:20px; padding:10px; margin-top:12px; box-shadow:var(--shadow)}
    .hero-photo{width:100%; height:auto; display:block; border-radius:14px; object-fit:contain; background:#f5f7ff;}
    .details-grid{display:grid; grid-template-columns:1fr; gap:16px; margin-top:16px}
    @media (min-width:860px){ .details-grid{ grid-template-columns: 1.8fr .9fr; } }
    .section{background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .section h2{margin:0 0 12px; font-size:1.18rem}
    .kv{display:grid; grid-template-columns:120px 1fr; gap:10px; margin:8px 0; font-size:1.02rem}
    .kv .k{color:var(--muted)}
    .info-note{margin-top:14px; background:#fff5fb; border:1px solid #ffd6ec; border-radius:16px; padding:12px}
    .info-note li{margin:8px 0}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    .btn{
      appearance:none; border:none; cursor:pointer; background:#fff; color:var(--ink); font-weight:800; border-radius:14px; padding:12px 16px;
      display:inline-flex; align-items:center; gap:10px; box-shadow:var(--shadow); text-decoration:none; transition: transform .08s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99) }
    .gif-card{ border-radius:22px; padding:12px; background:linear-gradient(180deg,#fff,#f9ffff); box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center; }
    .gif{width:100%; height:auto; display:block; border-radius:16px;}
    .map{border-radius:18px; overflow:hidden; box-shadow:var(--shadow); margin-top:12px}
    .choices{display:none}
    .rsvp-wrap{ margin-top: 6px; }
    .rsvp-options{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:600px){ .rsvp-options{ grid-template-columns:repeat(3,1fr);} }
    .rsvp-btn{
      appearance:none; border:none; cursor:pointer; padding:14px 18px; border-radius:999px; font-weight:800; color:var(--ink);
      box-shadow:0 8px 20px rgba(0,0,0,.08); transition:transform .08s ease, filter .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
      text-align:center; min-width:160px; border:2px solid transparent;
    }
    .rsvp-btn[data-choice="YES"]{ background:var(--lilac); }
    .rsvp-btn[data-choice="NO"]{ background:var(--blush); }
    .rsvp-btn[data-choice="MAYBE"]{ background:var(--baby); }
    .rsvp-btn:hover{ filter:brightness(.96); box-shadow:0 12px 26px rgba(0,0,0,.12); }
    .rsvp-btn.selected{ filter:brightness(.93); border-color: rgba(0,0,0,.25); background:#F7D774 !important; border-color:#bfa52a !important; box-shadow:0 12px 28px rgba(0,0,0,.16) !important; transform: translateY(-1px) scale(1.02) !important; }
    #submitRSVP{ margin-top:12px; padding:12px 18px; border-radius:12px; border:none; background:var(--lav); color:var(--ink); font-weight:900; cursor:pointer; box-shadow:0 8px 22px rgba(0,0,0,.12); }
    #submitRSVP:hover{ filter:brightness(.96) }
    #rsvpAck{ margin-top:10px; font-weight:700; text-align:center }
    #saveAllergy{ background:var(--lav); color:var(--ink); border:none; padding:10px 14px; border-radius:12px; font-weight:800; box-shadow:0 6px 18px rgba(0,0,0,.10); }
    textarea{ width:100%; min-height:96px; border:1px solid var(--border); border-radius:14px; padding:12px; font-size:1rem; background:linear-gradient(180deg,#fff,#fbfbff); color:var(--ink); }
    #musicBtn {position:fixed;right:14px;bottom:14px;z-index:40;padding:10px 12px;border:0;border-radius:999px;font-weight:800;background:#fff;box-shadow:0 8px 22px rgba(0,0,0,.12); color:var(--ink);}
    .toast{ position:fixed; left:50%; bottom:14px; transform:translate(-50%, 30px); background:var(--toast); color:var(--ink); border-radius:16px; box-shadow:0 14px 34px rgba(0,0,0,.18); padding:12px 14px; display:flex; align-items:center; gap:10px; z-index:50; opacity:0; pointer-events:none; animation: toast-in .28s ease forwards; }
    .toast.hide{ animation: toast-out .25s ease forwards; }
    .toast img{ width:28px; height:28px; border-radius:8px }
    @keyframes toast-in{ from{opacity:0; transform:translate(-50%, 30px)} to{opacity:1; transform:translate(-50%, 0)} }
    @keyframes toast-out{ from{opacity:1; transform:translate(-50%, 0)} to{opacity:0; transform:translate(-50%, 30px)} }

    /* Who's coming dropdown */
    .attending{margin-top:14px}
    .attend-toggle{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-radius:14px;
      background:linear-gradient(135deg,var(--bar-start),var(--bar-end));
      color:#fff; font-weight:800; cursor:pointer; user-select:none;
      box-shadow:0 8px 20px rgba(129,117,228,.25); border:1px solid rgba(255,255,255,.35);
    }
    .attend-toggle .count{opacity:.95; font-weight:700; font-size:.95rem}
    .attend-toggle .arrow{transition:transform .2s ease}
    .attend-toggle[aria-expanded="true"] .arrow{ transform:rotate(180deg) }
    .attend-panel{
      background:#fff; border:1px solid var(--border); border-radius:14px;
      padding:12px; margin-top:8px; box-shadow:0 6px 12px rgba(0,0,0,.05);
    }
    .pills{display:flex;flex-wrap:wrap;gap:8px}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#f9fafb}
    .hidden{display:none}

    /* Countdown */
    .countdown { 
      margin-top:12px; 
      display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;
    }
    .cd-seg { 
      background:#fff; border:1px solid var(--border); border-radius:12px; 
      padding:10px 12px; min-width:72px; text-align:center; box-shadow:var(--shadow); 
    }
    .cd-num { font-weight:900; font-size:1.3rem; }
    .cd-label { display:block; font-size:.8rem; color:var(--muted); margin-top:2px; }

    /* Disabled RSVP look */
    .rsvp-btn[aria-disabled="true"],
    #submitRSVP:disabled {
      filter: grayscale(0.15) brightness(0.94);
      cursor: not-allowed;
      opacity: .7;
    }

    /* Fade-in animation for footer */
    .fade-in { opacity:0; transform:translateY(12px); animation:fadeInUp 0.8s ease forwards; }
    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(12px); }
      to   { opacity:1; transform:translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <section class="hero" aria-labelledby="title">
      <h1 id="title">üéÇ You‚Äôre Invited to My 7th Birthday Party!</h1>
      <p id="hiName"></p>
      <p class="tagline">
        It‚Äôs my 7th birthday and I can‚Äôt wait to celebrate with you!
        Come play with me at the soft play, then stay for party food,
        birthday cake, and lots of fun, laughter, and memories to take home.
      </p>
      <div class="hero-photo-wrap">
        <img class="hero-photo" src="https://i.ibb.co/xtf6pZNb/cali.jpg" alt="Cali smiling" />
      </div>
    </section>

    <section class="details-grid">
      <div class="section">
        <h2 id="details-heading">Event Details</h2>
        <div class="kv"><div class="k">Date</div><div>Saturday, <strong>20 September 2025</strong></div></div>
        <div class="kv"><div class="k">Time</div><div><strong>14:00‚Äì15:00</strong> soft play, snacks & cake after</div></div>
        <div class="kv"><div class="k">Venue</div><div><strong>Swiss Cottage Leisure Centre</strong><br/>Adelaide Rd, London NW3 3NF</div></div>

        <!-- Countdown -->
        <div class="section" style="margin-top:12px;padding:12px">
          <h3 style="margin:0 0 8px;font-size:1.05rem">‚è≥ Party starts in</h3>
          <div id="countdownWrap" class="countdown" aria-live="polite">
            <div class="cd-seg"><span id="cdDays" class="cd-num">--</span><span class="cd-label">days</span></div>
            <div class="cd-seg"><span id="cdHours" class="cd-num">--</span><span class="cd-label">hours</span></div>
            <div class="cd-seg"><span id="cdMins" class="cd-num">--</span><span class="cd-label">mins</span></div>
            <div class="cd-seg"><span id="cdSecs" class="cd-num">--</span><span class="cd-label">secs</span></div>
          </div>
          <p id="countdownMsg" class="note" style="text-align:center;margin:8px 0 0;color:#6b7280"></p>
        </div>

        <div class="info-note">
          <ul>
            <li>üß∏ <strong>Drop-off party</strong>, but parents are very welcome to stay if they wish.</li>
            <li>üç∞ <strong>Snacks and birthday cake will be served</strong> ‚Äî please let us know about any <u>allergies</u> or dietary needs.</li>
          </ul>
        </div>
        <div class="btns">
          <button id="btnICS" class="btn" type="button">üì• Save to Calendar (.ics)</button>
          <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/maps/dir/?api=1&destination=Swiss+Cottage+Leisure+Centre+NW3+3NF">üöó Start Google Navigation</a>
          <a class="btn" target="_blank" rel="noopener" href="http://maps.apple.com/?daddr=Swiss%20Cottage%20Leisure%20Centre%20NW3%203NF">üöô Start Apple Navigation</a>
        </div>
        <div class="map">
          <iframe title="Map to Swiss Cottage Leisure Centre" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2483.611136410285!2d-0.1746041233010678!3d51.5441746109931!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x48761ac3141a5df9%3A0x85a06e1c1dc8d2d9!2sSwiss%20Cottage%20Leisure%20Centre!5e0!3m2!1sen!2suk!4v1726222337687!5m2!1sen!2suk" width="100%" height="290" style="border:0" allowfullscreen loading="lazy"></iframe>
        </div>
      </div>
      <aside class="gif-card" aria-label="Party vibe">
        <img class="gif" src="https://media.giphy.com/media/o0JqY89wfQUU/giphy.gif" alt="Cinnamoroll celebrating" />
      </aside>
    </section>

    <!-- RSVP -->
    <section class="section" aria-labelledby="rsvp-heading">
      <h2 id="rsvp-heading">RSVP</h2>
      <p id="deadlineNote" class="note" style="margin:6px 0;color:#6b7280">
        Please RSVP by <strong>Monday, 15 September 2025, 12:00 (noon)</strong>.
      </p>
      <p class="note">Pick one, write allergies (or leave blank for ‚ÄúNone‚Äù), then press Submit üíú</p>
      <div class="rsvp-wrap">
        <div class="rsvp-options" id="rsvpOptions">
          <button class="rsvp-btn" data-choice="YES">üéâ Yes, I‚Äôll be there!</button>
          <button class="rsvp-btn" data-choice="NO">üíå Sorry, I can‚Äôt make it</button>
          <button class="rsvp-btn" data-choice="MAYBE">ü§ó Maybe ‚Äî will confirm</button>
        </div>
        <div style="display:flex;justify-content:center">
          <button id="submitRSVP" type="button">Submit RSVP</button>
        </div>
        <div id="rsvpAck" aria-live="polite"></div>
        <p id="rsvpRecorded" class="note" style="display:none; text-align:center; margin-top:10px">‚úîÔ∏è Your response has been recorded.</p>
      </div>

      <div class="section" style="margin-top:12px;padding:12px">
        <label for="allergyField" style="display:block;font-weight:700;margin-bottom:6px">Allergies / dietary notes</label>
        <textarea id="allergyField" placeholder="e.g., nut‚Äëfree, vegetarian, halal"></textarea>
        <div style="display:flex; gap:10px; align-items:center; margin-top:10px">
          <button id="saveAllergy" type="button">üíæ Save allergies</button>
          <small id="allergyHint" style="color:var(--muted)">Leave blank and we‚Äôll save <em>None</em>.</small>
        </div>
        <p id="savedNote" class="note" style="display:none;margin-top:8px">Saved ‚Äî thank you!</p>
      </div>

      <!-- Who's coming (dropdown, collapsed by default) -->
      <div class="attending" id="attending">
        <div class="attend-toggle" id="attendToggle" aria-expanded="false" role="button" tabindex="0">
          <span>Who‚Äôs coming</span>
          <span class="count"><span id="attendingCount">0</span> confirmed <span class="arrow">‚ñº</span></span>
        </div>
        <div class="attend-panel hidden" id="attendPanel" aria-hidden="true">
          <div class="pills" id="attendingList"></div>
        </div>
      </div>
    </section>

    <!-- Footer: Stitch message -->
    <section class="section fade-in">
      <div style="display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap;text-align:left">
        <img src="https://i.ibb.co/FMVH1QP/caliandstitch.gif" 
             alt="Excited character cheering" 
             style="max-width:180px;width:100%;height:auto;border-radius:16px;box-shadow:var(--shadow)" />
        <p style="font-weight:700;font-size:1.1rem;color:var(--ink);margin:0">
          Aloha! Stitch very excited‚Äîparty mean games, cake, and many giggles. Ohana means family, and family means we celebrate together. 
          Stitch see you at the party, okie? Save tiny piece of cake for blue guy! üíô
        </p>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" style="display:none">
    <img src="https://media.giphy.com/media/o0JqY89wfQUU/giphy.gif" alt="" aria-hidden="true" />
    <span id="toastMsg"></span>
  </div>

  <!-- YouTube background music -->
  <div id="yt-holder" style="position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden;"></div>
  <button id="musicBtn">üéµ sound on</button>
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- Firebase + Firestore logging with validation + upserts + attending list -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtC4RvoYxotfxDyp32gjeFediehdaWrLs",
      authDomain: "cali-s-birthday.firebaseapp.com",
      projectId: "cali-s-birthday",
      storageBucket: "cali-s-birthday.firebasestorage.app",
      messagingSenderId: "68111770262",
      appId: "1:68111770262:web:fe550fad91db7d409bd8b7",
      measurementId: "G-50S5Y76DMQ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const qs = new URLSearchParams(location.search);
    const toNameRaw = (qs.get("to") || "").trim();
    const kids = (qs.get("kids") || "").trim();
    const adults = (qs.get("adults") || "").trim();
    const contactPrefill = (qs.get("contact") || "").trim();
    const allergiesPrefill = (qs.get("allergy") || "").trim();

    function idFor(name){
      return name.trim().toLowerCase().replace(/[\/#?\[\]]/g,'_').replace(/\s+/g,'-').slice(0,120) || "_unknown";
    }

    const hasName = !!toNameRaw;
    const toNameDisplay = toNameRaw;
    const docId = hasName ? idFor(toNameRaw) : "_unknown";

    if (hasName) {
      const el = document.getElementById("hiName");
      if (el) el.textContent = `Hi ${toNameDisplay}!`;
    } else {
      const el = document.getElementById("hiName");
      if (el) el.textContent = `Hi there!`;
    }

    // Log view (allowed without name)
    try {
      await addDoc(collection(db, "views"), {
        to: hasName ? toNameDisplay : null, kids: kids || null, adults: adults || null,
        contact: contactPrefill || null, allergy: allergiesPrefill || null,
        ts: serverTimestamp(), referrer: document.referrer || null, ua: navigator.userAgent
      });
    } catch (e) { console.error("View log error:", e); }

    const allergyField = document.getElementById("allergyField");
    if (allergiesPrefill) allergyField.value = allergiesPrefill;

    // Save allergies (blocked if missing name)
    document.getElementById("saveAllergy").addEventListener("click", async ()=>{
      if (!hasName){ showToast("This link is missing your name. Please use your personal invite link.", "üîí"); return; }
      const text = (allergyField.value.trim() || "None");
      try{
        await setDoc(doc(db, "allergies", docId), {
          to: toNameDisplay, kids: kids || null, adults: adults || null,
          allergy: text, contact: contactPrefill || null, ts: serverTimestamp()
        }, { merge: true });
        allergyField.value = text;
        const n = document.getElementById("savedNote");
        n.style.display = "block"; setTimeout(()=> n.style.display="none", 2500);
      }catch(e){ alert("Could not save right now. Please try again."); }
    });

    // Centralized submit that REQUIRES RSVP + allergy + NAME
    async function submitWithValidation(choice){
      if (!hasName) throw new Error("This link is missing your name. Please open your personal invite link.");
      const allergy = (allergyField.value.trim() || "None");
      if (!choice) throw new Error("Please choose an RSVP option.");
      await setDoc(doc(db, "allergies", docId), {
        to: toNameDisplay, kids: kids || null, adults: adults || null,
        allergy, contact: contactPrefill || null, ts: serverTimestamp()
      }, { merge: true });
      await setDoc(doc(db, "rsvps", docId), {
        to: toNameDisplay, kids: kids || null, adults: adults || null, contact: contactPrefill || null,
        allergy, choice, ts: serverTimestamp()
      }, { merge: true });
      allergyField.value = allergy;
      return true;
    }
    window.__submitRSVPValidated = submitWithValidation;

    // --- Who's coming (YES) ---
    const attendingCountEl = document.getElementById("attendingCount");
    const attendingList = document.getElementById("attendingList");
    const attendToggle = document.getElementById("attendToggle");
    const attendPanel = document.getElementById("attendPanel");

    function renderAttending(names){
      attendingCountEl.textContent = names.length.toString();
      attendingList.innerHTML = "";
      if (!names.length){
        attendPanel.classList.add("hidden");
        attendToggle.setAttribute("aria-expanded","false");
        attendPanel.setAttribute("aria-hidden","true");
        return;
      }
      const frag = document.createDocumentFragment();
      names.forEach(n=>{
        const span = document.createElement("span");
        span.className = "pill";
        span.textContent = n;
        frag.appendChild(span);
      });
      attendingList.appendChild(frag);
    }

    // Collapsed by default
    attendToggle.addEventListener("click", ()=>{
      const expanded = attendToggle.getAttribute("aria-expanded")==="true";
      attendToggle.setAttribute("aria-expanded", String(!expanded));
      attendPanel.setAttribute("aria-hidden", String(expanded));
      attendPanel.classList.toggle("hidden");
    });
    attendToggle.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); attendToggle.click(); }
    });

    // Live YES list
    const qR = query(collection(db, "rsvps"), orderBy("ts","desc"));
    onSnapshot(qR, (snap)=>{
      const set = new Set();
      snap.docs.forEach(d=>{
        const r = d.data() || {};
        const name = String(r.to||"").trim();
        const choice = String(r.choice||"").toLowerCase();
        if (name && name !== "(unknown)" && choice === "yes"){
          set.add(name);
        }
      });
      const names = Array.from(set).sort((a,b)=>a.localeCompare(b));
      renderAttending(names);
    });
  </script>

  <!-- Non-module JS for calendar + music + RSVP selection + toast + deadline + countdown -->
  <script>
    const eventTitle   = "Cali‚Äôs 7th Birthday Soft Play Party";
    const eventWhere   = "Swiss Cottage Leisure Centre, Adelaide Rd, London NW3 3NF";
    // London time (BST) for start/end
    const EVENT_START  = new Date('2025-09-20T14:00:00+01:00');
    const eventEnd     = new Date('2025-09-20T15:00:00+01:00');
    const musicBtn = document.getElementById('musicBtn');

    function pad(n){return n.toString().padStart(2,"0")}
    function toICSDate(d){ return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+"T"+pad(d.getUTCHours())+pad(d.getUTCMinutes())+"00Z"; }
    document.getElementById("btnICS").addEventListener("click", ()=>{
      const uid = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Cali7//Birthday//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${toICSDate(new Date())}
DTSTART:${toICSDate(new Date(Date.UTC(2025, 8, 20, 13, 0)))}
DTEND:${toICSDate(new Date(Date.UTC(2025, 8, 20, 14, 0)))}
SUMMARY:${eventTitle}
LOCATION:${eventWhere}
DESCRIPTION:14:00‚Äì15:00 soft play, then snacks & cake.
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics], {type:"text/calendar"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "cali-birthday-2025.ics"; a.click();
    });

    // One global showToast used by all scripts
    function showToast(msg, emoji){
      const t = document.getElementById('toast');
      const msgEl = document.getElementById('toastMsg');
      msgEl.textContent = `${emoji} Cali says: ${msg}`;
      t.style.display = 'flex';
      t.classList.remove('hide');
      setTimeout(()=>{ t.classList.add('hide'); setTimeout(()=>{ t.style.display='none'; }, 250); }, 4000);
    }

    // ===== RSVP deadline guard (Europe/London) =====
    const RSVP_DEADLINE = new Date('2025-09-15T12:00:00+01:00'); // Mon 15 Sep 2025, 12:00 London (BST)

    function rsvpClosed() { return new Date() >= RSVP_DEADLINE; }

    function disableRSVPUI() {
      document.querySelectorAll('.rsvp-btn').forEach(b=>{
        b.setAttribute('aria-disabled','true');
        b.disabled = true;
        b.classList.remove('selected');
      });
      const submit = document.getElementById('submitRSVP');
      if (submit) submit.disabled = true;
      const ack = document.getElementById('rsvpAck');
      if (ack) ack.textContent = 'üíú Cali says: Unfortunately, submission is no longer possible.';
    }

    function showClosedMessage() { showToast('Unfortunately, submission is no longer possible.', 'üíú'); }

    // On load, if past deadline, lock UI
    if (rsvpClosed()) disableRSVPUI();

    // Auto-lock exactly at the deadline if page stays open
    const ms = RSVP_DEADLINE - new Date();
    if (ms > 0 && ms < 2**31) {
      setTimeout(() => { disableRSVPUI(); showClosedMessage(); }, ms);
    }

    // Intercept RSVP clicks BEFORE existing handler
    const submitBtn = document.getElementById('submitRSVP');
    if (submitBtn) {
      submitBtn.addEventListener('click', (e) => {
        if (rsvpClosed()) {
          e.stopImmediatePropagation();
          e.preventDefault();
          disableRSVPUI();
          showClosedMessage();
        }
      }, { capture: true });
    }
    document.querySelectorAll('.rsvp-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        if (rsvpClosed()) {
          e.stopImmediatePropagation();
          e.preventDefault();
          disableRSVPUI();
          showClosedMessage();
        }
      }, { capture: true });
    });

    // ===== Countdown to event start =====
    const cdDays  = document.getElementById('cdDays');
    const cdHours = document.getElementById('cdHours');
    const cdMins  = document.getElementById('cdMins');
    const cdSecs  = document.getElementById('cdSecs');
    const cdMsg   = document.getElementById('countdownMsg');

    function updateCountdown(){
      const now = new Date();
      let diff = Math.floor((EVENT_START - now)/1000);
      if (diff <= 0){
        cdMsg.textContent = 'üéâ It‚Äôs party time!';
        cdDays.textContent = cdHours.textContent = cdMins.textContent = cdSecs.textContent = '00';
        return;
      }
      const d = Math.floor(diff / 86400); diff -= d*86400;
      const h = Math.floor(diff / 3600);  diff -= h*3600;
      const m = Math.floor(diff / 60);    diff -= m*60;
      const s = diff;

      cdDays.textContent  = String(d).padStart(2,'0');
      cdHours.textContent = String(h).padStart(2,'0');
      cdMins.textContent  = String(m).padStart(2,'0');
      cdSecs.textContent  = String(s).padStart(2,'0');
      cdMsg.textContent = '';
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // --- Background music (YouTube) ---
    let player, unmuted = false;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('yt-holder', {
        height: '1', width: '1',
        videoId: 'MG6x8OpXCp8', // updated video ID
        playerVars: { autoplay: 1, loop: 1, playlist: 'MG6x8OpXCp8', controls: 0, disablekb: 1, fs: 0, modestbranding: 1, playsinline: 1, rel: 0, iv_load_policy: 3 },
        events: { 'onReady': onYTReady }
      });
    }
    function onYTReady(){
      try { player.mute(); player.playVideo(); } catch(e){}
      const resume = () => {
        if (unmuted) return;
        unmuted = true;
        try { player.unMute(); player.setVolume(70); if (typeof showToast==='function') { showToast('Now playing music!', 'üé∂'); } } catch(e){}
        musicBtn.textContent = 'üîá mute';
        window.removeEventListener('pointerdown', resume, {once:true});
        window.removeEventListener('touchstart', resume, {once:true});
        window.removeEventListener('scroll', resume, {once:true});
      };
      window.addEventListener('pointerdown', resume, { once:true, passive:true });
      window.addEventListener('touchstart', resume, { once:true, passive:true });
      window.addEventListener('scroll', resume, { once:true, passive:true });
    }
    function fadeVolume(from, to, ms){
      if (!player || typeof player.setVolume !== 'function') return;
      const steps = 12, dt = ms/steps, dv = (to-from)/steps;
      let v = from; player.setVolume(v);
      const t = setInterval(()=>{
        v += dv; player.setVolume(Math.max(0, Math.min(100, v)));
        if ((dv>0 && v>=to) || (dv<0 && v<=to)) clearInterval(t);
      }, dt);
    }
    musicBtn.addEventListener('click', () => {
      if (!player) return;
      if (player.isMuted() || player.getVolume() === 0) {
        try { player.unMute(); fadeVolume(0, 70, 300); } catch(e){}
        musicBtn.textContent = 'üîá mute';
      } else {
        fadeVolume(player.getVolume(), 0, 200);
        setTimeout(()=>player.mute(), 220);
        musicBtn.textContent = 'üéµ sound on';
      }
    });

    // --- RSVP select + submit + toast ---
    const optionsWrap = document.getElementById('rsvpOptions');
    let selected = null;
    optionsWrap.querySelectorAll('.rsvp-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        optionsWrap.querySelectorAll('.rsvp-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selected = btn.getAttribute('data-choice');
      }, {passive:true});
    });

    document.getElementById('submitRSVP').addEventListener('click', async () => {
      const qs = new URLSearchParams(location.search);
      const name = (qs.get('to') || '').trim();
      if (!selected) { showToast('Please pick an RSVP option first üôÇ', 'ü§ó'); return; }
      if (!name) { showToast('This link is missing your name. Please use your personal invite link.', 'üîí'); return; }

      const allergyField = document.getElementById('allergyField');
      if (!allergyField.value.trim()){
        allergyField.value = 'None';
      }

      try {
        if (window.__submitRSVPValidated) {
          await window.__submitRSVPValidated(selected);
        }
        document.getElementById('rsvpRecorded').style.display = 'block';
        if (selected === 'YES') { showToast(`Yay! I can‚Äôt wait to see you, ${name}!`, 'üéâ'); }
        else if (selected === 'NO') { showToast(`Thanks for letting me know, ${name}. I‚Äôll miss you!`, 'üíå'); }
        else { showToast(`That‚Äôs okay, ${name} ‚Äî just tell me when you can!`, 'ü§ó'); }
      } catch (e) {
        showToast(e?.message || 'Please complete RSVP & allergies first.', '‚ö†Ô∏è');
      }
    });
  </script>
</body>
</html>
